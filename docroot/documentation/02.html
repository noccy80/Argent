<!DOCTYPE html>
<html>
	<head>
		<title>Argent Documentation</title>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<link rel="stylesheet" type="text/css" href="../style/style.css" />
		<style></style>
	</head>
	<body><div class="marginalized">
		<h1>Argent Documentation</h1>
		<h2>Modules</h2>
		<p>Modules add functionality to the Argent server. If you can program it in JavaScript, you can make it an Argent module. A simple example is the <span class="preform">blacklist</span> module, which allows or denies requests for pages and API calls based on the IP address of the client and the module's configuration.</p>
		<p>All modules must have three specific functions defined, even if they're empty. They are:</p>
		<p><ul>
			<li><span class="preform">init()</span></li>
			<li><span class="preform">receiveRequest(r, u, q)</span></li>
			<li><span class="preform">shutdown()</span></li>
		</ul></p>
		<p><span class="preform">init()</span> gets run once for each module after Argent has read its main config but before the socket is opened to receive connections. This function returns a <span class="preform">0</span> upon success or any other number upon error (best practice would be to use numerical numbers). The Argent node process will exit with that error code. You can use this like a sort of constructor. If there are variables set in <a href="04.html">httpd.conf</a>, they will have been assigned by now. The <span class="preform">blacklist</span> module uses this function to read in its blacklist from a separate file, for example.</p>
		<p><span class="preform">receiveRequest(r, u, q)</span> - This gets called in each module after an HTTP request has been received by Argent, but before any major processing has been done with that data. <span class="preform">r</span> is a node.js Request object. <span class="preform">u</span> is the URL in the request. <span class="preform">q</span> is the parsed query attached to the URL. This function must return a binary <span class="preform">true</span> value or a JSON object with a <span class="preform">httpcode</span> integer and a <span class="preform">message</span> string. <span class="preform">httpcode</span> will be the response code sent to the client. <span class="preform">message</span> will be written to stderr.</p>
		<p>For example, when the blacklist module determines a client is not allowed to access the Argent server, its <span class="preform">receiveRequest</span> function returns this:
<pre>{
    "httpcode":403,
    "message":"IP address " + r.connection.remoteAddress + " is blacklisted."
}</pre>
<p>The client will be given an HTTP error 403 (Forbidden), Argent will send with that error any configured 403 error document, and log <span class="preform">IP address 123.45.67.89 is blacklisted.</span>
		<p><span class="preform">true</span> means that the module has finished any work it needed to do with this data. A string value will result in the server rejecting the request, responding with a 500 internal server error, and printing the string to the Argent error log. Use this if you need to interrupt the request for any reason. The blacklist module uses this to get the IP addresses on incoming requests and either allowing them (returns true) or rejecting them (returns a string explaining why, which is usually that your IP is in the blacklist).</p>
		<p><span class="preform">shutdown()</span> - This gets called for each module when Argent receives a SIGINT signal (on a Linux terminal, this gets sent to a process with a Ctrl+C). Any value this function returns will be summarily ignored.</p>
		<p>There are two additional rules to obey here. First, the filename of the module must be <span class="preform">moduleName.js</span>, and the module's object name must be <span class="preform">moduleName</span>. In other words, the filename and the object name in code must be identical - except for the addition of the file extension on the filename - and case matters. Second, you must store your object in the global <span class="preform">mods</span> namespace.</p>
		<p>For example, the following is a good template for starting a module:</p>
<pre>
mods.moduleName = {
    init:function(return 0;){},
    receiveRequest(r, u, q){},
    shutdown(){}
};
</pre>
	</body>
</html>
